const MIN_PRICE = 100000;
const MAX_PRICE = 10000000;
const MIN_YEAR = 1935;
const MAX_YEAR = 2021;
const MIN_KM = 0;
const MAX_KM = 1000000;
const maxYearSelectElement = document.getElementById("maxYear");
const minYearSelectElement = document.getElementById("minYear");
const maxKmSelectElement = document.getElementById("maxKm");
const minKmSelectElement = document.getElementById("minKm");
const maxPriceSelectElement = document.getElementById("maxPrice");
const minPriceSelectElement = document.getElementById("minPrice");
const brandSelectElement = document.getElementById("brandCar");
const modelSelectElement = document.getElementById("modelCar");





buildYearOption(document.getElementById("minYear"));
buildPriceOption(document.getElementById("minPrice"));
buildKmOption(document.getElementById("minKm"));

function formatNumber(number){
    return new Intl.NumberFormat("de-DE").format(number);
}

function notYear(id){
    return id != document.getElementById("minYear") && id != document.getElementById("maxYear");
}

function createOptionElement(select,value){
    option = document.createElement("option");
    option.setAttribute( "id", value+"" ) ;
    option.setAttribute("value",""+value);
    var innerValue = value;
    if (notYear(select))
        innerValue =formatNumber(value); 
    option.innerHTML = innerValue;
    select.appendChild(option);
}

function buildYearOption(year){
    for (let i = MIN_YEAR; i < MAX_YEAR; i++) {
        const actualYear = i;
        createOptionElement(year,actualYear);
    }
}

function buildMaxYear(selected){
    maxYear = document.getElementById("maxYear");
    borrar(maxYear);
    for (let i = selected; i < MAX_YEAR; i++) {
        const actualYear = i;
        createOptionElement(maxYear,actualYear);
    }
}

function buildPriceOption(minPrice){
    var initialPrice = MIN_PRICE;
    for (let i = 1; initialPrice < MAX_PRICE; i++) {
        createOptionElement(minPrice,initialPrice);
        initialPrice += 50000;
    }
}

function buildMaxPrice(selected){
    var initialPrice = parseInt(selected);
    const maxPrice = document.getElementById("maxPrice");
    borrar(maxPrice);
    for (let i = 1; initialPrice < MAX_PRICE; i++) {
        createOptionElement(maxPrice,initialPrice);
        initialPrice += 50000;
    }
}

function showSelectedMinYear(){
    var cod = document.getElementById("minYear").value;
    buildMaxYear(cod);
}

function showSelectedMinPrice(){
    var cod = document.getElementById("minPrice").value;
    buildMaxPrice(cod);
}

function borrar(element) {
    for (let i = element.length; i >= 0; i--) {
        element.remove(i);        
    }
  }

function buildKmOption(minKm){
    var currentKm = MIN_KM;
    for (let i = 1; currentKm < MAX_KM; i++) {
        createOptionElement(minKm,currentKm);
        currentKm += 10000;
    }
}

function showSelectedMinKm(){
    var selectedKm = document.getElementById("minKm").value;
    buildMaxKm(selectedKm);
}

function buildMaxKm(selected){
    var initialKm = parseInt(selected);
    const maxKm = document.getElementById("maxKm");
    borrar(maxKm);
    for (let i = 1; initialKm < MAX_KM; i++) {
        createOptionElement(maxKm,initialKm);
        initialKm += 10000;
    }
}

jQuery(document).ready(function (){
    jQuery('select[name="brandCar"]').on('change',function(){
        var brandName = jQuery(this).val();
        if(brandName){
           reqAjaxModels(brandName);
        }
        else{
            $('select[name="modelCar"]').empty();
        }
    });
});

function reqAjaxModels(brandName){
    jQuery.ajax({
        url : '/getModels/' +brandName,
        type : "GET",
        dataType : "json",
        success:function(data){
            jQuery('select[name="modelCar"]').empty();
            jQuery.each(data,function(key,value){
                $('select[name="modelCar"]').append('<option value="'+key+'">'+value+'</option>');
            });
        }
    });
}

function searchInDataBase(){
    var allValues = getAllValuesJson();
    reqAjaxCarsInfo(JSON.stringify(allValues));
}

function getAllValuesJson(){
    return {
        "brand" : brandSelectElement.options[brandSelectElement.selectedIndex].value,
       "model" : modelSelectElement.options[modelSelectElement.selectedIndex].value,
       "minPrice" : minPriceSelectElement.options[minPriceSelectElement.selectedIndex].value,
       "maxPrice" : maxPriceSelectElement.options[maxPriceSelectElement.selectedIndex].value,
       "minYear" : minYearSelectElement.options[minYearSelectElement.selectedIndex].value,
       "maxYear" : maxYearSelectElement.options[maxYearSelectElement.selectedIndex].value,
       "minKm" : minKmSelectElement.options[minKmSelectElement.selectedIndex].value,
       "maxKm" : maxKmSelectElement.options[maxKmSelectElement.selectedIndex].value,
       }
}

function reqAjaxCarsInfo(jsonData){
    
    jQuery(document).ready(function (){
        jQuery.ajax({
            url : '/getCarsInfo/'+jsonData,
            type : "GET",
            dataType : "json",
            success:function(data2){
                alert(data2);
            }
        });
        
    });
} 

